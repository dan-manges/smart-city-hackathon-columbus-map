<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin="">
    <style type="text/css">
      #map {
        height: 1280px; width: 1280px; margin: auto;
        background-color:rgba(255,0,0,0.0);
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg==" crossorigin=""></script>
    <script type="text/javascript">
      function heatMapColorForValue(value){
        var h = (1.0 - value) * 240;
        return "hsl(" + h + ", 100%, 50%)";
      }
    </script>
    <script type="text/javascript">
      $(function () {
        var map = L.map('map').setView([40, -83], 12);

        var consolidatedData = {};
        var count = 0;

        function getData(weekday, completeCallback) {
          console.log('getting data for weekday ' + weekday);
          jQuery.getJSON('columbus-driving-data-' + weekday + '.json', function (data) {
            data.drivingData.forEach(function (dataPoint) {
              count += 1;
              var roundedLat = parseFloat(dataPoint.latitude).toFixed(4);
              var roundedLong = parseFloat(dataPoint.longitude).toFixed(4);
              if (!consolidatedData[roundedLat]) consolidatedData[roundedLat] = {};
              if (!consolidatedData[roundedLat][roundedLong]) consolidatedData[roundedLat][roundedLong] = { count: 0, speed: 0 };

              var newCount = consolidatedData[roundedLat][roundedLong].count + 1;
              var newSpeed = ((consolidatedData[roundedLat][roundedLong].speed * (newCount - 1)) + parseFloat(dataPoint.speed)) / newCount;
              consolidatedData[roundedLat][roundedLong].count = newCount;
              consolidatedData[roundedLat][roundedLong].speed = newSpeed;
            });
            completeCallback();
          });
        }

        var weekday = 0;
        var completeCallback = function () {
          if (weekday < 6) {
            weekday += 1;
            getData(weekday, completeCallback);
          } else {
            console.log(count);
            // console.log(consolidatedData);

            var consolidatedCount = 0;
            Object.keys(consolidatedData).forEach(function (latitude) {
              Object.keys(consolidatedData[latitude]).forEach(function (longitude) {
                var count = consolidatedData[latitude][longitude].count;
                var speed = consolidatedData[latitude][longitude].speed;
                consolidatedCount += 1;
                if (count < 2) return;
                var ratio = (speed - 20) / 8;
                if (ratio > 1.0) ratio = 1.0;
                if (ratio < 0) ratio = NaN;
                L.circle([latitude, longitude], {radius: 1, color: heatMapColorForValue(ratio)}).addTo(map);
              });
            });
            console.log(consolidatedCount);
          }
        };

        getData(weekday, completeCallback);
      });
    </script>
  </body>
</html>
